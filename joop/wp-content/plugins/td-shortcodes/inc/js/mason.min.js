(function(e){e.fn.mason=function(t,n){var r={itemSelector:null,ratio:0,sizes:[],columns:[[0,480,1],[480,780,2],[780,1080,3],[1080,1320,4],[1320,1680,5]],promoted:[],filler:{itemSelector:t.itemSelector,filler_class:"mason_filler"},layout:"none",gutter:0};if(n){var i={complete:n}}var s={block:{height:0,width:0},matrix:[]};return this.each(function(){function f(){if(a.children(".mason_clear").length<1){a.append("<div class='mason_clear' style='clear:both;position:relative;'></div>")}s.block.height=parseFloat((a.width()/c()/o.ratio).toFixed(0));s.block.width=parseFloat(a.width()/c());l()}function l(){var t=c();var n=1;if(t==1){$sel=a.children(o.itemSelector);$sel.height(s.block.height);$sel.width(s.block.width);$sel.css({margin:"0px"})}else{for(var r=0;r<o.promoted.length;r++){o.sizes.push([o.promoted[r][0],o.promoted[r][1]])}a.children(o.itemSelector).each(function(){$sel=e(this);m=Math.floor(Math.random()*(o.sizes.length-o.promoted.length));ranSize=o.sizes[m];for(var t=0;t<o.promoted.length;t++){if($sel.hasClass(o.promoted[t][2])){ranSize=[o.promoted[t][0],o.promoted[t][1]];m=o.sizes.length-o.promoted.length+t}}$sel.data("size",m);var n=parseFloat((s.block.height*ranSize[1]).toFixed(2));n=n-o.gutter*2;var r=parseFloat(s.block.width*ranSize[0]);r=r-o.gutter*2;$sel.height(n+"px");$sel.width(r+"px");$sel.css({margin:o.gutter})});var i=a.height();var f=i/s.block.height;s.matrix=[];for(var r=0;r<f;r++){s.matrix[r]=[];for(var l=0;l<t;l++){s.matrix[r][l]=false}}a.children(o.itemSelector).each(function(){$sel=e(this);var t=Math.round($sel.position().left/s.block.width);var n=Math.round($sel.position().top/s.block.height);var r=parseFloat($sel.data("size"));var i=o.sizes[r][1];var u=o.sizes[r][0];var a=i*u;for(var f=0;f<a;f++){for(var l=0;l<i;l++){s.matrix[n+l][t]=true;for(var c=0;c<u;c++){s.matrix[n+l][t+c]=true}}}});for(var r=0;r<s.matrix.length;r++){for(var l=0;l<s.matrix[r].length;l++){if(s.matrix[r][l]==false){var h=parseFloat(s.block.height),p=parseFloat(s.block.width);var d=parseFloat((r*h).toFixed(2))+o.gutter,v=parseFloat(l*p)+o.gutter,m,g;h=h-o.gutter*2;p=p-o.gutter*2;m=Math.floor(Math.random()*e(o.filler.itemSelector).length);g=e(o.filler.itemSelector).eq(n).clone();n++;g.addClass(o.filler.filler_class);g.css({position:"absolute",top:d+"px",left:v+"px",height:h+"px",width:p+"px",margin:"0px"});g.appendTo(a)}}}if(u.complete!=null){u.complete()}}}function c(){var e=Math.floor(a.width()),t=0,n=o.columns.length-1;if(e>=o.columns[n][1]){t=o.columns[n][2]}else{for(var r=0;r<=n;r++){if(e>o.columns[r][0]&&e<o.columns[r][1]){t=o.columns[r][2]}}}return t}var o,u,a;o=e.extend(r,t);u=e.extend(i,n);a=e(this);var h=function(){var e={};return function(t,n,r){if(!r){r=p()}if(e[r]){clearTimeout(e[r])}e[r]=setTimeout(t,n)}}();var p=function(){var e="";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var n=0;n<5;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e};if(o.layout=="fluid"){e(window).resize(function(){e("."+o.filler.filler_class).remove();s.matrix=[];h(function(){e("."+o.filler.filler_class).remove();f()},150)})}f()})}})(jQuery)